<!DOCTYPE html>
<!-- This is a starting page that showcases sattelites above the picked location. -->
<html>
<head lang="en">
  <meta charset="UTF-8">
  <title>WorldWind Example</title>
  <link href="startingPageStyle.css" rel="stylesheet">
  <!-- Include the Web WorldWind library. -->
  <script src="https://files.worldwind.arc.nasa.gov/artifactory/web/0.9.0/worldwind.min.js"></script>
  <script src="https://slowe.github.io/stuquery/js/stuquery.min.js"></script>
  <script src="https://rawgit.com/slowe/VirtualSky/gh-pages/virtualsky.min.js" type="text/javascript"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>

<body>
  <!--div for planetarium-->
  <div id="planetarium-div"></div>
  <!-- div for world window-->
  <div id="wwd-div">
    <p id="intro-msg">Click on your location to see the sky!</p>
    <canvas id="wwd-canvas">
        Your browser does not support HTML5 Canvas.
    </canvas>
  </div>

  <script>
    var planetarium;
    var locationPicked = false;

    S(document).ready(function() {
    });

    // Register an event listener to be called when the page is loaded.
    window.addEventListener("load", eventWindowLoaded, false);
    // Create a WorldWindow for the canvas.
    var wwd = new WorldWind.WorldWindow("wwd-canvas");

    // Define the event listener to initialize Web WorldWind.
    function eventWindowLoaded() {

        // Add some image layers to the WorldWindow's globe.
        wwd.addLayer(new WorldWind.BMNGOneImageLayer());
        wwd.addLayer(new WorldWind.BMNGLandsatLayer());

        // Add a compass, a coordinates display and some view controls to the WorldWindow.
        wwd.addLayer(new WorldWind.CompassLayer());
        wwd.addLayer(new WorldWind.CoordinatesDisplayLayer(wwd));
        wwd.addLayer(new WorldWind.ViewControlsLayer(wwd));

        // Navigator configurations
        wwd.navigator.tilt = 60;
        wwd.navigator.range = 5000000;

    // The common gesture-handling function.
    var handleClick = function (recognizer) {
        // Obtain the event location.
        var x = recognizer.clientX,
            y = recognizer.clientY;

            // Perform the pick. Must first convert from window coordinates to canvas coordinates, which are
            // relative to the upper left corner of the canvas rather than the upper left corner of the page.
            var pickList = wwd.pick(wwd.canvasCoordinates(x, y));

            // If only one thing is picked and it is the terrain, tell the WorldWindow to go to the picked location.
            if (pickList.objects.length === 1 && pickList.objects[0].isTerrain) {
                var position = pickList.objects[0].position;
                if (locationPicked)
                  wwd.goTo(new WorldWind.Location(position.latitude, position.longitude));
                else {   // open the planetarium at picked location
                    locationPicked = true;

                    // Array to store the id's of the above sattelites
                    var aboveID = [];

                    $.ajax({
                        data: {cmd:"above",
                                obs_lat:position.latitude,
                                obs_lng:position.longitude,
                                obs_alt:"0",
                                search_radius:"70",
                                cat_id:"1"},
                        url: 'handle_api_requests.php',
                        method: 'POST', // or GET
                        success: function(msg) {
                            console.log(response.info.transactionscount);
                            // fill the arrray with all the ID's of above sattelites
                            var i;
                            for (i=0; i<response.above.length; i++) {
                            aboveID[i] =  response.above[i].satid;
                                console.log(response.above[i].satname);
                                console.log(response.above[i].satlat);
                                console.log(response.above[i].satlng);
                                console.log(i);
                                console.log("-----");
                            }
                        }
                    });



                    // fill these arrays with the sattelite coordinates to place them on the planetarium
                    var ra = [];
                    var dec = [];
                    var name = [];
                    // fill these arrays to pass coordinates to the gyroscope
                    var az = [];
                    var alt = [];

                    // make a new request for every object ID you have to find its ra/dec coordinates
                    for (var j=0; j<aboveID.length; j++) {

                        $.ajax({
                            data: {cmd:"positions",
                                id:aboveID[j],
                                obs_lat:position.latitude,
                                obs_lng:position.longitude,
                                obs_alt:"2",
                                sec:"1"},
                            url: 'handle_api_requests.php',
                            method: 'POST', // or GET
                            success: function(response) {
                                ra[j] = response.positions[0].ra;
                                dec[j] = response.positions[0].dec;
                                name[j] = response.info.satname;
                                az[j] = response.positions[0].azimuth;
                                alt[j] = response.positions[0].elevation; 
                            }
                        }); 
                    }

                    // draw the planetarium
                    planetarium = S.virtualsky({
                        id: 'planetarium-div',
                        projection: 'stereo',
                        latitude: position.latitude,
                        longitude: position.longitude,
                        clock:new Date()
                    });

                    // add the sattelites to the planetarium

                    for (var s=0; s<aboveID.length; s++) {
                        // if satellite is unlocked the url redirects to the second page
                        var myURL;
                        // TO-DO ::
                        // insert condition isUnlocked(aboveID[s]) here
                        if (true) {
                            // Create the URL. Encode satellite ID for the next page to draw him.
                            myURL = "wwdPage.html?id=" + encodeURIComponent(aboveID[s]);
                        }
                        else {
                            // pass to the gyroscope az, alt, id, and observer coordinates
                            // TO-DO:: The ui is overloaded by api calls. better give the gyroscope only the id to avoid using extra arrays az and alt. We'll see that.
                            myURL ="checkVisibility.html?id=" + encodeURIComponent(aboveID[s]) + "?az=" + encodeURIComponent(az[s]) + "?alt=" + encodeURIComponent(alt[s])
                                    + "?lat=" + encodeURIComponent(position.latitude) + "?long=" + encodeURIComponent(position.longitude);
                            console.log(encodeURIComponent(aboveID[s]) + " " + encodeURIComponent(az[s]) + " " + encodeURIComponent(alt[s]) + " " +
                                    encodeURIComponent(position.latitude) + " " + encodeURIComponent(position.longitude));
                        }
                        planetarium.addPointer({
                            'ra':ra[s],
                            'dec':dec[s],
                            'label':name[s],
                            'img':'https://media.wired.com/photos/5b52582f59269e342890a45a/1:1/w_1800,h_1800,c_limit/Satellite_FHM56J.jpg',
                            'url':myURL,
                            'credit':name[s],
                            'colour':'rgb(255,0,0)'
                        })
                    } 

                    // change z-index of planetarium to make it visible
                    var div = document.getElementById('planetarium-div');
                    div.style["z-index"]="2";
                    var wwddiv = document.getElementById('wwd-div');
                    wwddiv.style["visibility"]="hidden";
                }
            }
        };

        // Listen for mouse clicks.
        var clickRecognizer = new WorldWind.ClickRecognizer(wwd, handleClick);

        // Listen for taps on mobile devices.
        var tapRecognizer = new WorldWind.TapRecognizer(wwd, handleClick); }
  </script>
</body>
</html>

